<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Malla</title>
  <link rel="stylesheet" href="../css/inicio2.css">
</head>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const rut = localStorage.getItem("rut");
  const carreras = JSON.parse(localStorage.getItem("carreras") || "[]");

  const mensaje = document.createElement("div");
  mensaje.style.marginTop = "15px";
  document.querySelector("main").appendChild(mensaje);

  // Verificar login
  if (!rut || carreras.length === 0) {
    alert("Por favor, inicia sesión nuevamente.");
    window.location.href = "index.html";
    return;
  }

  // Mostrar datos básicos del estudiante
  const user = localStorage.getItem("usuario");
  document.getElementById("usuarioNombre").textContent = user;
  document.getElementById("usuarioRut").textContent = rut;

  // Tomar la primera carrera (por ahora)
  const carrera = carreras[0];
  mensaje.innerHTML = `<p><strong>Cargando malla de ${carrera.nombre} (${carrera.codigo})...</strong></p>`;

  const url = `https://losvilos.ucn.cl/hawaii/api/mallas?${carrera.codigo}-${carrera.catalogo}`;

  const headers = new Headers();
  headers.append("X-HAWAII-AUTH", "jf400fejof13f");

  const requestOptions = {
    method: "GET",
    headers: headers,
    redirect: "follow"
  };

  try {
    const response = await fetch(url, requestOptions);
    if (!response.ok) throw new Error(`Error HTTP ${response.status}`);

    const rawText = await response.text();
    console.log("Respuesta cruda de malla:", rawText);

    let data;
    try {
      data = JSON.parse(rawText);
    } catch (err) {
      throw new Error("Error al parsear la respuesta JSON.");
    }

    if (!Array.isArray(data) || data.length === 0) {
      mensaje.innerHTML = "<p>No se encontró información de malla para esta carrera.</p>";
      return;
    }

    // Crear tabla
    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>Código</th>
          <th>Asignatura</th>
          <th>Créditos</th>
          <th>Nivel</th>
          <th>Prerrequisitos</th>
        </tr>
      </thead>
      <tbody>
        ${data.map(curso => `
          <tr>
            <td>${curso.codigo}</td>
            <td>${curso.asignatura}</td>
            <td>${curso.creditos}</td>
            <td>${curso.nivel}</td>
            <td>${curso.prereq || "—"}</td>
          </tr>
        `).join("")}
      </tbody>
    `;
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.style.marginTop = "15px";
    table.querySelectorAll("th, td").forEach(el => {
      el.style.border = "1px solid #ddd";
      el.style.padding = "8px";
    });

    // Mostrar la tabla
    mensaje.innerHTML = `<h3>Malla de ${carrera.nombre}</h3>`;
    mensaje.appendChild(table);

  } catch (error) {
    console.error("Error al obtener malla:", error);
    mensaje.innerHTML = `<p style="color:orange;">Error al conectar con la API de malla.</p>`;
  }
});
</script>
<body>
  <nav>
    <ul>
      <li><a href="../html2/malla.html" class="active">Mi Malla</a></li>
      <li><a href="../html2/resumen.html">Resumen</a></li>
      <li><a href="../html2/comparacion.html">Comparación</a></li>
      <li><a href="../html2/versiones.html">Versiones</a></li>
      <li><a href="../html2/perfil.html">Perfil</a></li>
      <li><a href="../html2/index.html" class="logout">Salir</a></li>
    </ul>
  </nav>
  <main>
    <h2>Bienvenido, <span id="usuarioNombre"></span></h2>
    <p>RUT: <span id="usuarioRut"></span></p>
    <!-- Aquí se cargará la malla -->
  </main>


  <footer>
    <p>© 2025 Universidad del Norte</p>
  </footer>

  <script src="../js2/main.js"></script>
</body>
</html>
